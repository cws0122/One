<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BoardDAO">

	<insert id="insertBoard">
			insert into board(seq, title, writer, content , password , bgroup ) 
			values (board_seq.nextval, #{title}, #{writer}, #{content} , #{password} , board_groupseq.nextval )
	</insert> 
	
	<!-- insertReply -->
	
	<insert id="insertReply">
			insert into board(seq, title, writer, content , password , bgroup , grouporder , depth) 
			values (board_seq.nextval, #{title}, #{writer}, #{content} , #{password} , #{bgroup} , #{grouporder} , #{depth})
	</insert> 
	
	<update id="updateReply">
		<![CDATA[
			update board
			set grouporder = grouporder + 1
			where bgroup = #{bgroup} and grouporder > 0
		]]>
	</update>
	
	<update id="updateReplyre">
		<![CDATA[
			update board
			set grouporder = grouporder + 1
			where bgroup = #{bgroup} and grouporder >= #{grouporder}
		]]>
	</update>
	
	<update id="updateBoard">
		<![CDATA[
			update board
			set  title = #{title}, content = #{content} , password = #{password} , writer = #{writer}
			where seq = #{seq}
		]]>
	</update>
	
	<update id="viewcnt">
		<![CDATA[
			update board
			set viewcnt = viewcnt + 1
			where seq = #{seq}
		]]>
	</update>
	
	<delete id="deleteBoard">
		<![CDATA[
			delete board where seq=${seq}
		]]>
	</delete>
	
	<!-- 전체 게시물의 개수 구하는 쿼리 -->
	<select id="getTotal" resultType="int">
		<![CDATA[
				select count(*) from board
		]]>
	</select>
	
	<select id="getOneTotal" resultType="int">
		<![CDATA[
				select count(*) from board
				where depth = 0
		]]>
	</select>
	
	<select id="getAllBoardList" resultType="board">
		<![CDATA[
				select * from board
				where deleted = 0
				order by seq desc
		]]>
	</select>
	
	<select id="getBoardBySeq" resultType="board">
		select * from board
		where seq = #{seq}
	</select>

	<select id="getAllBoardCount" resultType="int" >
		select count(seq) from board
	</select>
	
	<select id="Allcount" resultType="int">
		select count(seq) from board
		where deleted = 0
	</select>
	
	<!-- 원글만 뽑기 -->
	<select id="BoardListPaging" resultType="board">
		select * from (select 
		ROWNUM as rnum, b.* 
		from (select * from board order by bgroup desc , grouporder asc) b) 
		where rnum between (#{cPage}-1)*#{numPerPage} + 1 and #{cPage}*#{numPerPage}
	</select>
	
	<select id="searchBoard" resultType="board">
		select * from board
			<where>
				<if test='searchCondition.equals("title")'>
					title like '%'||#{searchKeyword}||'%'
				</if>
				<if test='searchCondition.equals("content")'>
					content like '%'||#{searchKeyword}||'%'
				</if>
				<if test='searchCondition.equals("writer")'>
					writer like '%'||#{searchKeyword}||'%'
				</if>
			</where>
		order by seq desc
	</select>
	
	<select id="searchBoardPaging" resultType="board">
		select * from (select
		Rownum as rnum , b.*
		from(
			select * from board
				<where>
					<if test="searchCondition == 'title'">
						title like '%'||#{searchKeyword}||'%'
					</if>
					<if test="searchCondition == 'content'">
						content like '%'||#{searchKeyword}||'%'
					</if>
					<if test="searchCondition == 'writer'">
						writer like '%'||#{searchKeyword}||'%'
					</if>
				</where>
			order by seq desc
		) b)
		where rnum between (#{cPage}-1)*#{numPerPage} + 1 and #{cPage}*#{numPerPage}
	</select>
	
	<select id="searchBoardCount" resultType="int" >
		select count(*) from board
			<where>
				<if test="searchCondition == 'title'">
					title like '%'||#{searchKeyword}||'%'
				</if>
				<if test="searchCondition == 'content'">
					content like '%'||#{searchKeyword}||'%'
				</if>
				<if test="searchCondition == 'writer'">
					writer like '%'||#{searchKeyword}||'%'
				</if>
			</where>
	</select>

	<select id="searchReply" resultType="board">
		select * from board
		where bgroup = #{bgroup} and grouporder = ${grouporder + 1} and depth = ${depth + 1}
	</select>

	<update id="deleted">
		update board
		set deleted = 1
		where seq = #{seq}
	</update>
	
	<update id="deleteinfo">
		update board
		set writer = null , password = null , title = null , content = null , regdate = null , viewcnt = null
		where seq = #{seq}
	</update>



<!-- 댓글 구현 -->


	<select id="replyList" resultType="reply">
		select * from boardcomment
		where boardseq = #{seq}
		order by seq desc
	</select>

	<insert id="insertCmt">
		insert into boardcomment(seq , boardseq , writer , password , content)
		values(comment_seq.nextval, #{boardseq} , #{writer} ,  #{password} ,  #{content})
	</insert>

	<update id="countup">
		update board
		set count = count + 1
		where seq = #{seq}
	</update>
	
	<update id="countdown">
		update board
		set count = count - 1
		where seq = #{seq}
	</update>

	<select id="getcommentByseq" resultType="reply">
		select * from boardcomment
		where seq = #{seq}
	</select>
	
	<update id="cmtupdate">
		update boardcomment
		set writer = #{writer} , password = #{password} , content = #{content}
		where seq = #{seq}
	</update>

	<delete id="deleteCmt">
		<![CDATA[
			delete boardcomment 
			where seq=${seq}
		]]>
	</delete>
	
	<!-- 파일 업로드 부분 -->
	
	<insert id="insertFile" parameterType="hashmap">
		<![CDATA[
			insert into boardfile(seq , boardseq , ori_filename , saved_filename , file_size, regdate)
			values (file_seq.nextval , #{BOARDSEQ} , #{ORG_FILE_NAME} , #{STORED_FILE_NAME} , #{FILE_SIZE} , sysdate)
		]]>
	</insert>
	
	<select id="getseq" resultType="int">
		select max(seq) from board
	</select>
	
	<select id="detailFileSeq" resultType="hashmap">
		<![CDATA[
			select seq , boardseq , ori_filename , saved_filename, round(file_size/1024, 1) as file_size
			from boardfile
			where boardseq = #{seq} and deleted = 'N'
		]]>
	</select>
	
	<select id="detailFile" resultType="hashmap" parameterType="hashmap">
		<![CDATA[
			select seq , boardseq , ori_filename , saved_filename, round(file_size/1024, 1) as file_size
			from boardfile
			where boardseq = #{seq} and deleted = 'N'
		]]>
	</select>
	
	<select id="selectFileInfo" resultType="hashmap">
		select seq ,boardseq , ori_filename , saved_filename  from boardfile
		where seq = #{seq} and deleted = 'N' order by seq asc
	</select>
	
	<update id="deleteFile" parameterType="hashmap">
			update boardfile
			set deleted = 'Y'
			where seq = #{FILE_NO}
	</update>
	
	<update id="updateFile" parameterType="hashmap">
		update boardfile
		set deleted = 'N'
		where seq = #{BOARDSEQ}
	</update>
	
	<delete id="deleteAllFile">
		<![CDATA[
			delete boardfile
			where boardseq = #{seq}
		]]>
	</delete>
	
	<select id="filecount" resultType="int">
		select count(*) from boardfile
		where boardseq = #{seq} and deleted = 'N'
	</select>

	<update id="filecountUpdate">
		update board
		set filecount = #{filecount}
		where seq = #{seq}
	</update>
	
	<select id="excelList" resultType="board">
		select ROWNUM , b.title , b.writer , b.regdate , b.viewcnt , b.filecount
		from (select * from board order by seq desc)b;
	</select>








</mapper>